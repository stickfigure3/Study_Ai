{# templates/settings/account.html #}
{% extends "base.html" %}
{# Import the macro for rendering form fields cleanly #}
{% from 'includes/_formhelpers.html' import render_field %}

{% block title %}Account Settings{% endblock %}

{% block content %}
<div class="content-section">
    <h2 class="border-bottom mb-4">Account Settings</h2>

    {# --------------------- #}
    {# --- API Key Form --- #}
    {# --------------------- #}
    {# This form POSTs back to the same route (settings.account_settings) #}
    <form method="POST" action="{{ url_for('settings.account_settings') }}" class="mb-5">
        {{ settings_form.hidden_tag() }} {# CSRF Token #}
        <fieldset class="form-group">
            <legend class="h5">OpenAI API Key</legend>
            {# Display current status based on variable passed from route #}
            <p>Status: <span class="badge {% if api_key_status == 'Set' %}bg-success{% else %}bg-warning text-dark{% endif %}">{{ api_key_status }}</span></p>

            {# Render the API Key field using the macro #}
            {# Label is automatically generated by the macro based on the field name #}
            {{ render_field(settings_form.api_key, class="form-control", placeholder="Enter new key (e.g., sk-...) or leave blank to clear", label_visible=True) }}

            <div class="form-text mb-3">
                Your API key is stored encrypted. Enter a new key to update, or leave blank and submit to remove the current key. You can find your key on the <a href="https://platform.openai.com/account/api-keys" target="_blank" rel="noopener noreferrer">OpenAI website</a>.
            </div>
        </fieldset>
        <div class="form-group">
            {# Render the submit button for this specific form #}
            {{ settings_form.submit_api_key(class="btn btn-primary") }}
        </div>
    </form>

    <hr>

    {# -------------------- #}
    {# --- Theme Form --- #}
    {# -------------------- #}
    {# This form POSTs to the main.generate_theme route #}
    <form method="POST" action="{{ url_for('main.generate_theme') }}" id="theme-form">
        {{ theme_form.hidden_tag() }} {# CSRF Token #}
        <fieldset class="form-group">
            <legend class="h5">Generate CSS Theme (Session)</legend>
            <p class="text-muted">Describe the visual theme you want (e.g., "dark mode with blue accents", "minimalist light theme"). The AI will generate CSS, which will be applied for your current browser session.</p>

            {# Render the theme description field using the macro #}
            {{ render_field(theme_form.theme_description, class="form-control", placeholder="e.g., dark mode, ocean blue, professional gray", label_visible=True) }}

        </fieldset>
        <div class="form-group">
            {# Render the submit button for the theme form #}
            {{ theme_form.submit_theme(class="btn btn-secondary", id="theme-button") }} {# Use the specific submit field from ThemeForm #}

            {# Spinner element (controlled by JS) #}
            <span id="theme-spinner" class="spinner-border spinner-border-sm ms-2" role="status" aria-hidden="true" style="display: none; vertical-align: middle;"></span>

            {# Link to clear the theme (goes to main.clear_theme route) #}
            <a href="{{ url_for('main.clear_theme') }}" class="btn btn-outline-secondary ms-2">Reset to Default Theme</a>
        </div>
    </form>

    {# Display current theme CSS if it exists in the session #}
    {% if session.get('custom_css') %}
    <div class="mt-4">
        <p><strong>Current custom theme is active.</strong> Generated CSS:</p>
        <pre style="max-height: 200px; overflow-y: auto; background-color: #e9ecef; padding: 10px; border-radius: 5px; font-size: 0.8em;"><code>{{ session['custom_css'] }}</code></pre>
    </div>
    {% endif %}

</div>
{% endblock %}

{% block scripts %}
{# Include the JavaScript for the theme generation spinner #}
<script>
    const themeForm = document.getElementById('theme-form');
    const themeButton = document.getElementById('theme-button');
    const themeSpinner = document.getElementById('theme-spinner');

    if (themeForm && themeButton) {
        themeForm.addEventListener('submit', function(event) { // Added event parameter
            const themeDescInput = document.getElementById('theme_description'); // Check ID matches WTForms field
            if (themeDescInput && themeDescInput.value.trim() === '') {
                alert('Please enter a theme description.');
                event.preventDefault(); // Stop submission
                return;
            }
            themeButton.disabled = true;
            if(themeSpinner) themeSpinner.style.display = 'inline-block';
            // Update button text - find the button's text node carefully
            // This assumes the button text is the first child node
            if (themeButton.firstChild && themeButton.firstChild.nodeType === Node.TEXT_NODE) {
                themeButton.firstChild.nodeValue = ' Generating... '; // Add space for spinner
            } else {
                // Fallback if structure is different
                themeButton.innerHTML = '<span id="theme-spinner" class="spinner-border spinner-border-sm" role="status" aria-hidden="true" style="display: inline-block;"></span> Generating...';
            }
        });
    }
</script>
{% endblock %}